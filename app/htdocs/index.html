<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Model Acquisition Bot</title>
		<link rel="icon" href="/favicon.ico">
		<link rel="stylesheet" href="/assets/css/bootstrap.min.css">
		<link rel="stylesheet" href="/assets/css/all.min.css">
		<link rel="stylesheet" href="/assets/css/style.css">
	</head>
	<body>
		<main class="min-vh-100 container py-3">
			<section id="connect">
				<i class="fas fa-spinner fa-spin me-2"></i>Connecting
			</section>
			<section class="d-none" id="authenticate">
				<form>
					<div class="form-floating mb-3">
						<input type="password" class="form-control" id="password" placeholder="Password">
						<label for="password">Password</label>
					</div>
					<button type="submit" class="btn btn-primary">Authenticate</button>
				</form>
			</section>
			<section class="d-none" id="app">
				<ul class="nav nav-tabs mb-3">
					<li class="nav-item">
						<a class="nav-link active" href="#model" data-bs-toggle="tab">Model Acquisition</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#photogrammetry" data-bs-toggle="tab">Photogrammetry</a>
					</li>
				</ul>
				<div class="tab-content">
					<div class="tab-pane fade show active" id="model">
						<div id="settingsModel">
							<div class="row g-3">
								<div class="col">
									<div class="form-floating">
										<select class="form-select" id="savedSettingsModel"></select>
										<label for="savedSettingsModel">Saved settings</label>
									</div>
								</div>
								<div class="col-auto">
									<button type="button" class="btn btn-primary h-100 me-3" data-settings="model" data-action="load">Load</button><button type="button" class="btn btn-danger h-100" data-settings="model" data-action="delete">Delete</button>
								</div>
							</div>
							<hr>
							<div class="form-floating mb-3">
								<input type="text" class="form-control" id="cameraDistance" placeholder="Camera distance to object in meters">
								<label for="cameraDistance">Camera distance to object in meters</label>
							</div>
							<div class="form-floating mb-3">
								<input type="number" min="1" class="form-control" id="numPositions" placeholder="Number of robot positions">
								<label for="numPositions">Number of robot positions</label>
							</div>
							<div class="form-floating">
								<input type="number" min="1" class="form-control" id="numSpins" placeholder="Number of turntable spins">
								<label for="numSpins">Number of turntable spins</label>
							</div>
							<hr>
							<form class="mb-5" data-save="model">
								<div class="row g-3">
									<div class="col">
										<div class="form-floating">
											<input type="text" class="form-control" id="nameModel" placeholder="Name" required>
											<label for="nameModel">Settings name</label>
										</div>
									</div>
									<div class="col-auto">
										<button type="submit" class="btn btn-primary h-100">Save</button>
									</div>
								</div>
							</form>
							<div class="form-floating mb-3">
								<input type="text" class="form-control" id="workingDirModel" placeholder="Working directory" value="~">
								<label for="workingDirModel">Working directory</label>
							</div>
							<div class="form-floating mb-3">
								<input type="text" class="form-control" id="objectWidth" placeholder="Object width in meters">
								<label for="objectWidth">Object width in meters</label>
							</div>
							<div class="form-floating mb-3">
								<input type="text" class="form-control" id="objectLength" placeholder="Object length in meters">
								<label for="objectLength">Object length in meters</label>
							</div>
							<div class="form-floating mb-3">
								<input type="text" class="form-control" id="objectHeight" placeholder="Object height in meters">
								<label for="objectHeight">Object height in meters</label>
							</div>
							<div class="form-check mb-3">
								<input type="checkbox" class="form-check-input" id="simulation">
								<label class="form-check-label" for="simulation">Simulation</label>
							</div>
							<button class="btn btn-secondary me-3" id="test">Test</button><button class="btn btn-primary" id="startModel">Start</button>
						</div>
						<div class="d-none" id="processModel">
							<textarea class="form-control bg-dark text-light mb-3" rows="10"></textarea>
							<div class="progress mb-3" style="height: 40px;">
								<div class="progress-bar progress-bar-striped progress-bar-animated px-2 lead"></div>
							</div>
							<div class="accordion mb-3" id="modelAccordion">
								<div class="accordion-item">
									<h2 class="accordion-header">
										<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#livePreview">
											Live preview
										</button>
									</h2>
									<div id="livePreview" class="accordion-collapse collapse show" data-bs-parent="#modelAccordion">
										<div class="accordion-body">
											<img class="mw-100">
										</div>
									</div>
								</div>
							</div>
							<button class="btn btn-primary" data-close="model">Close</button><button class="btn btn-danger" data-stop="model">Stop</button>
						</div>
					</div>
					<div class="tab-pane fade" id="photogrammetry">
						<div id="settingsPhotogrammetry">
							<div class="row g-3">
								<div class="col">
									<div class="form-floating">
										<select class="form-select" id="savedSettingsPhotogrammetry"></select>
										<label for="savedSettingsPhotogrammetry">Saved settings</label>
									</div>
								</div>
								<div class="col-auto">
									<button type="button" class="btn btn-primary h-100 me-3" data-settings="photogrammetry" data-action="load">Load</button><button type="button" class="btn btn-danger h-100" data-settings="photogrammetry" data-action="delete">Delete</button>
								</div>
							</div>
							<hr>
							<div class="form-floating mb-3">
								<input type="number" class="form-control" id="depthMapDownscaling" placeholder="Depth map downscaling">
								<label for="depthMapDownscaling">Depth map downscaling</label>
							</div>
							<div class="form-check mb-3">
								<input type="checkbox" class="form-check-input" id="keepLargestMeshOnly">
								<label class="form-check-label" for="keepLargestMeshOnly">Keep largest mesh only</label>
							</div>
							<div class="form-floating">
								<input type="number" class="form-control" id="maxNumVertices" placeholder="Maximum number of vertices (0 for infinity)">
								<label for="maxNumVertices">Maximum number of vertices (0 for infinity)</label>
							</div>
							<hr>
							<form class="mb-5" data-save="photogrammetry">
								<div class="row g-3">
									<div class="col">
										<div class="form-floating">
											<input type="text" class="form-control" id="namePhotogrammetry" placeholder="Name" required>
											<label for="namePhotogrammetry">Settings name</label>
										</div>
									</div>
									<div class="col-auto">
										<button type="submit" class="btn btn-primary h-100">Save</button>
									</div>
								</div>
							</form>
							<div class="form-floating mb-3">
								<input type="text" class="form-control" id="workingDirPhotogrammetry" placeholder="Working directory" value="~">
								<label for="workingDirPhotogrammetry">Working directory</label>
							</div>
							<button class="btn btn-primary" id="startPhotogrammetry">Start</button>
						</div>
						<div class="d-none" id="processPhotogrammetry">
							<textarea class="form-control bg-dark text-light mb-3" rows="10"></textarea>
							<div class="progress mb-3" style="height: 40px;">
								<div class="progress-bar progress-bar-striped progress-bar-animated px-2 lead"></div>
							</div>
							<button class="btn btn-primary" data-close="photogrammetry">Close</button><button class="btn btn-danger" data-stop="photogrammetry">Stop</button>
						</div>
					</div>
				</div>
			</section>
		</main>
		<footer class="footer container-fluid bg-light py-3">
			<a target="_blank" href="https://github.com/code-iai/iai_mab_control"><i class="fab fa-github fa-2x fa-fw"></i></a>
		</footer>
		<script src="/assets/js/bootstrap.bundle.min.js"></script>
		<script src="/assets/js/modal.js"></script>
		<script>
		const connect = document.querySelector('#connect');
		const authenticate = document.querySelector('#authenticate');

		const settingsModel = document.querySelector('#settingsModel');
		const processModel = document.querySelector('#processModel');

		const settingsPhotogrammetry = document.querySelector('#settingsPhotogrammetry');
		const processPhotogrammetry = document.querySelector('#processPhotogrammetry');

		var connection;
		var settings;

		function send(op, msg) {
			connection.send(JSON.stringify({ op: op, msg: msg }));
		}

		function updateSettings(type) {
			const select = document.querySelector('#savedSettings' + (type == 'model' ? 'Model' : 'Photogrammetry'));
			select.innerHTML = '<option></option>';

			Object.keys(settings[type]).forEach(function(name) {
				const option = document.createElement('option');
				option.innerText = name;
				select.appendChild(option);
			});
		}

		function updateProgressBar(type, progress) {
			const bar = (type == 'model' ? processModel : processPhotogrammetry).querySelector('.progress-bar');
			bar.style.minWidth = progress + '%';
			bar.innerText = progress + '%';
		}

		const xhr = new XMLHttpRequest();
		xhr.open('POST', '/port', true);

		xhr.onreadystatechange = function() {
			if (this.readyState == XMLHttpRequest.DONE) {
				if (this.status == 200) {
					connection = new WebSocket('ws://' + location.hostname + ':' + xhr.responseText);

					connection.onopen = function() {
						connect.classList.add('d-none');
						authenticate.classList.remove('d-none');
					}

					connection.onclose = function(e) {
						if (connect.classList.contains('d-none')) {
							modal('Error', 'Connection lost. Reload to continue.', 'Close');
						} else {
							modal('Error', 'Failed to connect. Reload to try again.', 'Close');
						}
					};

					connection.onmessage = function(e) {
						const data = JSON.parse(e.data);
						const msg = data.msg;

						switch (data.op) {
							case 'AUTH_RESPONSE': {
								if (msg) {
									settings = msg;
									updateSettings('model');
									updateSettings('photogrammetry');
									authenticate.classList.add('d-none');
									document.querySelector('#app').classList.remove('d-none');
								} else {
									modal('Error', 'Wrong password.', 'Close');
								}

								break;
							}

							case 'START': {
								(msg == 'model' ? settingsModel : settingsPhotogrammetry).classList.add('d-none');
								const container = (msg == 'model' ? processModel : processPhotogrammetry);
								container.classList.remove('d-none');
								container.querySelector('textarea').value = '';
								updateProgressBar(msg, 0);

								if (msg == 'model') {
									document.querySelector('#livePreview img').src = '';
								}

								container.querySelector('[data-close]').classList.add('d-none');
								container.querySelector('[data-stop]').classList.remove('d-none');
								break;
							}

							case 'STOP': {
								const container = (msg == 'model' ? processModel : processPhotogrammetry);
								container.querySelector('[data-stop]').classList.add('d-none');
								container.querySelector('[data-close]').classList.remove('d-none');
								break;
							}

							case 'PROGRESS': {
								updateProgressBar(msg.type, msg.value);
								break;
							}

							case 'CONSOLE': {
								const console = (msg.type == 'model' ? processModel : processPhotogrammetry).querySelector('textarea');
								const scroll = console.scrollTop + console.clientHeight >= console.scrollHeight;
								console.value += msg.text;

								if (scroll) {
									console.scrollTop = console.scrollHeight;
								}

								break;
							}

							case 'PREVIEW': {
								document.querySelector('#livePreview img').src = 'data:image/jpeg;base64,' + msg.data;
								break;
							}
						}
					};
				} else {
					modal('Error', 'Failed to fetch port. Reload to try again.', 'Close');
				}
			}
		};

		xhr.send();

		authenticate.querySelector('form').addEventListener('submit', function(e) {
			e.preventDefault();
			send('AUTH', this.querySelector('#password').value);
		});

		document.querySelectorAll('[data-settings]').forEach(function(btn) {
			btn.addEventListener('click', function() {
				const type = this.getAttribute('data-settings');
				const name = document.querySelector('#savedSettings' + (type == 'model' ? 'Model' : 'Photogrammetry')).value;

				if (name) {
					const action = this.getAttribute('data-action');

					switch (action) {
						case 'load': {
							const params = settings[type][name];

							Object.keys(params).forEach(function(param) {
								const input = document.querySelector('#' + param);

								if (input.type == 'checkbox') {
									input.checked = params[param];
								} else {
									input.value = params[param];
								}
							});

							document.querySelector('#name' + (type == 'model' ? 'Model' : 'Photogrammetry')).value = name;
							break;
						}

						case 'delete': {
							delete settings[type][name];
							updateSettings(type);
							send('DELETE', { type: type, name: name });
							break;
						}
					}
				}
			});
		});

		document.querySelectorAll('[data-save]').forEach(function(f) {
			f.addEventListener('submit', function(e) {
				e.preventDefault();
				const type = this.getAttribute('data-save');
				const name = document.querySelector('#name' + (type == 'model' ? 'Model' : 'Photogrammetry')).value;
				const params = {};

				(type == 'model' ? ['cameraDistance', 'numPositions', 'numSpins'] : ['depthMapDownscaling', 'keepLargestMeshOnly', 'maxNumVertices']).forEach(function(param) {
					const input = document.querySelector('#' + param);
					params[param] = (input.type == 'checkbox' ? input.checked : input.value);
				});

				settings[type][name] = params;
				updateSettings(type);
				send('SAVE', { type: type, name: name, params: params });
			});
		});

		settingsModel.querySelectorAll('#test,#startModel').forEach(function(btn) {
			btn.addEventListener('click', function() {
				const cameraDistance = document.querySelector('#cameraDistance').value;

				if (!cameraDistance.length || !/^\d+(\.\d+)?$/.test(cameraDistance)) {
					modal('Error', '<p>Please enter the camera distance to object in meters.</p><p><i>Example: 0.2</i></p>', 'Close');
					return;
				}

				const numPositions = document.querySelector('#numPositions').value;

				if (!numPositions.length || !/^[1-9]\d*$/.test(numPositions)) {
					modal('Error', '<p>Please enter the number of robot positions.</p><p><i>Example: 15</i></p>', 'Close');
					return;
				}

				const numSpins = document.querySelector('#numSpins').value;

				if (!numSpins.length || !/^[1-9]\d*$/.test(numSpins)) {
					modal('Error', '<p>Please enter the number of turntable spins.</p><i>Example: 8</i></p>', 'Close');
					return;
				}

				const workingDir = document.querySelector('#workingDirModel').value;

				if (!workingDir.length) {
					modal('Error', 'Please enter the working directory.', 'Close');
					return;
				}

				const objectWidth = document.querySelector('#objectWidth').value;

				if (!objectWidth.length || !/^\d+(\.\d+)?$/.test(objectWidth)) {
					modal('Error', '<p>Please enter the object width in meters.</p><p><i>Example: 0.2</i></p>', 'Close');
					return;
				}

				const objectLength = document.querySelector('#objectLength').value;

				if (!objectLength.length || !/^\d+(\.\d+)?$/.test(objectWidth)) {
					modal('Error', '<p>Please enter the object length in meters.</p><p><i>Example: 0.2</i></p>', 'Close');
					return;
				}

				const objectHeight = document.querySelector('#objectHeight').value;

				if (!objectHeight.length || !/^\d+(\.\d+)?$/.test(objectWidth)) {
					modal('Error', '<p>Please enter the object height in meters.</p><p><i>Example: 0.2</i></p>', 'Close');
					return;
				}

				send('START', { type: 'model', workingDir: workingDir, '_min_distance': cameraDistance, '_num_positions': numPositions, '_num_spins': numSpins, '_object_size': '[' + objectWidth + ', ' + objectLength + ', ' + objectHeight + ']', '_simulation': document.querySelector('#simulation').checked, '_test': this.id == 'test' });
			});
		});

		settingsPhotogrammetry.querySelector('#startPhotogrammetry').addEventListener('click', function() {
			const depthMapDownscaling = document.querySelector('#depthMapDownscaling').value;

			if (!depthMapDownscaling.length || !/^[1-9]\d*$/.test(depthMapDownscaling)) {
				modal('Error', '<p>Please enter the depth map downscaling.</p><p><i>Example: 2</i></p>', 'Close');
				return;
			}

			const maxNumVertices = document.querySelector('#maxNumVertices').value;

			if (!maxNumVertices.length || !/^\d+$/.test(maxNumVertices)) {
				modal('Error', '<p>Please enter the maximum number of vertices.</p><p><i>Example: 0</i></p>', 'Close');
				return;
			}

			const workingDir = document.querySelector('#workingDirPhotogrammetry').value;

			if (!workingDir.length) {
				modal('Error', 'Please enter the working directory.', 'Close');
				return;
			}

			settingsPhotogrammetry.classList.add('d-none');
			processPhotogrammetry.classList.remove('d-none');
			send('START', { type: 'photogrammetry', workingDir: workingDir, depthMapDownscaling: depthMapDownscaling, keepLargestMeshOnly: document.querySelector('#keepLargestMeshOnly').checked, maxNumberVertices: maxNumVertices });
		});

		document.querySelectorAll('[data-close]').forEach(function(btn) {
			btn.addEventListener('click', function() {
				if (this.getAttribute('data-close') == 'model') {
					processModel.classList.add('d-none');
					settingsModel.classList.remove('d-none');
				} else {
					processPhotogrammetry.classList.add('d-none');
					settingsPhotogrammetry.classList.remove('d-none');
				}
			});
		});

		document.querySelectorAll('[data-stop]').forEach(function(btn) {
			btn.addEventListener('click', function() {
				send('STOP', this.getAttribute('data-stop'));
			});
		});
		</script>
	</body>
</html>
