<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Model Acquisition Bot</title>
		<link rel="icon" href="/favicon.ico">
		<link rel="stylesheet" href="/assets/css/bootstrap.min.css">
		<link rel="stylesheet" href="/assets/css/all.min.css">
		<link rel="stylesheet" href="/assets/css/style.css">
	</head>
	<body>
		<main class="min-vh-100 container py-3">
			<section id="connect">
				<form>
					<div class="form-floating mb-3">
						<input type="number" min="1" max="65535" class="form-control" id="port" placeholder="WebSocket Port" value="8080" required>
						<label for="port">WebSocket Port</label>
					</div>
					<button type="submit" class="btn btn-primary"><i class="fas fa-spinner fa-spin me-2 d-none"></i>Connect</button>
				</form>
			</section>
			<section class="d-none" id="authenticate">
				<form>
					<div class="form-floating mb-3">
						<input type="password" class="form-control" id="password" placeholder="Password" value="1337" required>
						<label for="password">Password</label>
					</div>
					<button type="submit" class="btn btn-primary"><i class="fas fa-spinner fa-spin me-2 d-none"></i>Authenticate</button>
				</form>
			</section>
			<section class="d-none" id="app">
				<div class="d-none">
					<textarea class="form-control bg-dark text-light mb-3" rows="10">> ...
> ...
> ...</textarea>
					<div class="progress mb-3" style="height: 40px;">
						<div class="progress-bar progress-bar-striped progress-bar-animated px-2 lead" style="min-width: 20%;">20%</div>
					</div>
					<p>Step 1 / 10: ...</p>
					<button class="btn btn-danger">Cancel</button>
				</div>
				<div class="form-floating mb-3">
					<input type="text" class="form-control" id="workingDirectory" placeholder="Working directory" value="~/">
					<label for="workingDirectory">Working directory</label>
				</div>
				<ul class="nav nav-tabs mb-3">
					<li class="nav-item">
						<a class="nav-link active" href="#model" data-bs-toggle="tab">Model acquisition</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#photogrammetry" data-bs-toggle="tab">Photogrammetry</a>
					</li>
				</ul>
				<div class="tab-content">
					<div class="tab-pane fade show active" id="model">
						<div class="form-floating mb-3">
							<input type="text" class="form-control" id="cameraDistance" placeholder="Camera distance to object">
							<label for="cameraDistance">Camera distance to object</label>
						</div>
						<div class="form-floating mb-3">
							<input type="number" class="form-control" id="numPositions" placeholder="Number of positions">
							<label for="numPositions">Number of positions</label>
						</div>
						<div class="form-floating">
							<input type="number" class="form-control" id="numSpins" placeholder="Number of spins">
							<label for="numSpins">Number of spins</label>
						</div>
						<hr>
						<div class="row g-3 mb-3">
							<div class="col">
								<div class="form-floating">
									<select class="form-select" id="savedSettingsModel"></select>
									<label for="savedSettingsModel">Saved settings</label>
								</div>
							</div>
							<div class="col-auto">
								<button type="button" class="btn btn-primary h-100 me-3" data-settings="model" data-action="load">Load</button><button type="button" class="btn btn-danger h-100" data-settings="model" data-action="delete"><i class="fas fa-spinner fa-spin me-2 d-none"></i>Delete</button>
							</div>
						</div>
						<form data-save="model">
							<div class="row g-3 mb-5">
								<div class="col">
									<div class="form-floating">
										<input type="text" class="form-control" id="nameModel" placeholder="Name" required>
										<label for="nameModel">Name</label>
									</div>
								</div>
								<div class="col-auto">
									<button type="submit" class="btn btn-primary h-100"><i class="fas fa-spinner fa-spin me-2 d-none"></i>Save</button>
								</div>
							</div>
						</form>
						<div class="form-floating mb-3">
							<input type="text" class="form-control" id="objectWidth" placeholder="Object width">
							<label for="objectWidth">Object width</label>
						</div>
						<div class="form-floating mb-3">
							<input type="text" class="form-control" id="objectLength" placeholder="Object length">
							<label for="objectLength">Object length</label>
						</div>
						<div class="form-floating mb-3">
							<input type="text" class="form-control" id="objectHeight" placeholder="Object height">
							<label for="objectHeight">Object height</label>
						</div>
						<div class="form-check mb-3">
							<input type="checkbox" class="form-check-input" id="simulation" value="">
							<label class="form-check-label" for="simulation">Simulation</label>
						</div>
						<button class="btn btn-secondary me-3">Test</button><button class="btn btn-primary">Start</button>
					</div>
					<div class="tab-pane fade" id="photogrammetry">
						<div class="form-floating mb-3">
							<input type="number" class="form-control" id="maxNumTriangles" placeholder="Maximum number of triangles">
							<label for="maxNumTriangles">Maximum number of triangles</label>
						</div>
						<div class="form-floating">
							<input type="number" class="form-control" id="maxNumVertices" placeholder="Maximum number of vertices">
							<label for="maxNumVertices">Maximum number of vertices</label>
						</div>
						<hr>
						<div class="row g-3 mb-3">
							<div class="col">
								<div class="form-floating">
									<select class="form-select" id="savedSettingsPhotogrammetry"></select>
									<label for="savedSettingsPhotogrammetry">Saved settings</label>
								</div>
							</div>
							<div class="col-auto">
								<button type="button" class="btn btn-primary h-100 me-3" data-settings="photogrammetry" data-action="load">Load</button><button type="button" class="btn btn-danger h-100" data-settings="photogrammetry" data-action="delete"><i class="fas fa-spinner fa-spin me-2 d-none"></i>Delete</button>
							</div>
						</div>
						<form data-save="photogrammetry">
							<div class="row g-3 mb-5">
								<div class="col">
									<div class="form-floating">
										<input type="text" class="form-control" id="namePhotogrammetry" placeholder="Name" required>
										<label for="namePhotogrammetry">Name</label>
									</div>
								</div>
								<div class="col-auto">
									<button type="submit" class="btn btn-primary h-100"><i class="fas fa-spinner fa-spin me-2 d-none"></i>Save</button>
								</div>
							</div>
						</form>
						<div class="form-floating mb-3">
							<input type="text" class="form-control" id="fileName" placeholder="File name" value="model">
							<label for="fileName">File name</label>
						</div>
						<div class="mb-3">
							<span class="me-3">Formats:</span><div class="form-check form-check-inline">
								<input type="checkbox" class="form-check-input" id="formatFBX" checked>
								<label class="form-check-label" for="formatFBX">FBX</label>
							</div><div class="form-check form-check-inline">
								<input type="checkbox" class="form-check-input" id="formatSTL" checked>
								<label class="form-check-label" for="formatSTL">STL</label>
							</div><div class="form-check form-check-inline">
								<input type="checkbox" class="form-check-input" id="formatDAE" checked>
								<label class="form-check-label" for="formatDAE">DAE</label>
							</div>
						</div>
						<button class="btn btn-primary">Start</button>
					</div>
				</div>
			</section>
		</main>
		<footer class="footer container-fluid bg-light py-3">
			<a target="_blank" href="https://github.com/code-iai/iai_mab_control"><i class="fab fa-github fa-2x fa-fw"></i></a>
		</footer>
		<script src="/assets/js/bootstrap.bundle.min.js"></script>
		<script>
		const connect = document.querySelector('#connect');
		const authenticate = document.querySelector('#authenticate');

		var connection;
		var settings;

		function send(op, msg) {
			connection.send(JSON.stringify({ op: op, msg: msg }));
		}

		function updateSettings(type) {
			const select = document.querySelector('#savedSettings' + (type == 'model' ? 'Model' : 'Photogrammetry'));
			select.innerHTML = '<option></option>';

			Object.keys(settings[type]).forEach(function(name) {
				const option = document.createElement('option');
				option.innerText = name;
				select.appendChild(option);
			});
		}

		connect.querySelector('form').addEventListener('submit', function(e) {
			e.preventDefault();
			const spinner = this.querySelector('.fa-spinner');
			spinner.classList.remove('d-none');
			connection = new WebSocket('ws://' + location.hostname + ':' + this.querySelector('#port').value);

			connection.onopen = function() {
				connect.classList.add('d-none');
				authenticate.classList.remove('d-none');
			}

			connection.onclose = function(e) {
				if (connect.classList.contains('d-none')) {
					location.reload();
				} else {
					spinner.classList.add('d-none');
					alert('Failed to connect.');
				}
			};

			connection.onmessage = function(e) {
				const data = JSON.parse(e.data);
				const msg = data.msg;

				switch (data.op) {
					case 'AUTH':
						authenticate.querySelector('.fa-spinner').classList.add('d-none');

						if (msg) {
							settings = msg;
							updateSettings('model');
							updateSettings('photogrammetry');
							authenticate.classList.add('d-none');
							document.querySelector('#app').classList.remove('d-none');
						} else {
							alert('Wrong password.');
						}

						break;
					case 'DELETE':
						document.querySelector('[data-settings="' + msg.type + '"][data-action="delete"] .fa-spinner').classList.add('d-none');
						delete settings[msg.type][msg.name];
						updateSettings(msg.type);
						break;
					case 'SAVE':
						document.querySelector('[data-save="' + msg.type + '"] .fa-spinner').classList.add('d-none');
						settings[msg.type][msg.name] = msg.params;
						updateSettings(msg.type);
						break;
				}
			};
		});

		authenticate.querySelector('form').addEventListener('submit', function(e) {
			e.preventDefault();
			this.querySelector('.fa-spinner').classList.remove('d-none');
			send('AUTH', this.querySelector('#password').value);
		});

		document.querySelectorAll('[data-settings]').forEach(function(btn) {
			btn.addEventListener('click', function() {
				const type = this.getAttribute('data-settings');
				const name = document.querySelector('#savedSettings' + (type == 'model' ? 'Model' : 'Photogrammetry')).value;

				if (name) {
					if (this.getAttribute('data-action') == 'load') {
						const params = settings[type][name];

						Object.keys(params).forEach(function(param) {
							document.querySelector('#' + param).value = params[param];
						});

						document.querySelector('#name' + (type == 'model' ? 'Model' : 'Photogrammetry')).value = name;
					} else {
						const spinner = this.querySelector('.fa-spinner');
						spinner.classList.remove('d-none');
						send('DELETE', { type: type, name: name });
					}
				}
			});
		});

		document.querySelectorAll('[data-save]').forEach(function(f) {
			f.addEventListener('submit', function(e) {
				e.preventDefault();
				const spinner = this.querySelector('.fa-spinner');
				spinner.classList.remove('d-none');
				const type = this.getAttribute('data-save');
				const name = document.querySelector('#name' + (type == 'model' ? 'Model' : 'Photogrammetry')).value;
				const params = {};

				(type == 'model' ? ['cameraDistance', 'numPositions', 'numSpins'] : ['maxNumTriangles', 'maxNumVertices']).forEach(function(param) {
					params[param] = document.querySelector('#' + param).value;
				});

				send('SAVE', { type: type, name: name, params: params });
			});
		});
		</script>
	</body>
</html>
